{
  "rules": {
    ".read": "auth != null",
    ".write": "auth != null",
    "chatRoom": {
      "users": {
        "$userId": {
          ".read": "auth != null",
          ".write": "auth != null && $userId === auth.uid",
          ".validate": "newData.hasChildren(['id','name','joinedAt','isTyping','lastSeen','color']) && newData.child('id').val() === auth.uid",
          "id": { ".validate": "newData.isString() && newData.val() == $userId" },
          "name": { ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 20" },
          "joinedAt": { ".validate": "newData.isNumber()" },
          "isTyping": { ".validate": "newData.isBoolean()" },
          "lastSeen": { ".validate": "newData.isNumber()" },
          "color": { ".validate": "newData.isString() && newData.val().matches('^#[0-9A-Fa-f]{6}$')" },
          "isOnline": { ".validate": "newData.isBoolean()" },
          "connectionState": { ".validate": "newData.isString() && (newData.val() == 'online' || newData.val() == 'offline' || newData.val() == 'away')" }
        }
      },
      "messages": {
        "$messageId": {
          ".read": "auth != null",
          ".write": "auth != null && newData.child('userId').val() == auth.uid",
          ".validate": "newData.hasChildren(['id','userId','userName','userColor','text','timestamp'])",
          "id": { ".validate": "newData.isString()" },
          "userId": { ".validate": "newData.isString() && newData.val() == auth.uid" },
          "userName": { ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 20" },
          "userColor": { ".validate": "newData.isString()" },
          "text": { ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 500" },
          "timestamp": { ".validate": "newData.isNumber() && newData.val() <= now + 60000" },
          "emoji": { ".validate": "newData.isString()" }
        }
      },
      "typing": {
        "$userId": {
          ".read": "auth != null",
          ".write": "auth != null && $userId == auth.uid",
          ".validate": "newData.hasChildren(['userId','userName','timestamp']) && newData.child('userId').val() == auth.uid",
          "userId": { ".validate": "newData.isString() && newData.val() == $userId" },
          "userName": { ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 20" },
          "timestamp": { ".validate": "newData.isNumber() && newData.val() <= now + 60000" }
        }
      },
      "presence": {
        "$userId": {
          ".read": "auth != null",
          ".write": "auth != null && $userId == auth.uid",
          ".validate": "newData.hasChildren(['isOnline','lastSeen','connectionState'])",
          "isOnline": { ".validate": "newData.isBoolean()" },
          "lastSeen": { ".validate": "newData.isNumber() && newData.val() <= now + 60000" },
          "connectionState": { ".validate": "newData.isString() && (newData.val() == 'online' || newData.val() == 'offline' || newData.val() == 'away')" }
        }
      },
      "metadata": {
        ".read": "auth != null",
        ".write": "auth != null && false"  
      }
    },
    ".info": { ".read": true }
  }
}